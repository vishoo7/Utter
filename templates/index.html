<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utter</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
  }

  h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #fff;
    letter-spacing: 0.05em;
  }

  .tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1.5rem;
  }
  .tab {
    padding: 0.6rem 1.5rem;
    background: #16213e;
    color: #888;
    border: 1px solid #333;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
  }
  .tab:first-child { border-radius: 6px 0 0 6px; }
  .tab:last-child { border-radius: 0 6px 6px 0; }
  .tab.active { background: #0f3460; color: #fff; border-color: #0f3460; }

  .container {
    width: 100%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .panel { display: none; }
  .panel.active { display: flex; flex-direction: column; gap: 1rem; }

  textarea {
    width: 100%;
    min-height: 250px;
    padding: 1rem;
    border: 1px solid #333;
    border-radius: 8px;
    background: #16213e;
    color: #e0e0e0;
    font-size: 1rem;
    line-height: 1.5;
    resize: vertical;
    font-family: inherit;
  }
  textarea:focus { outline: none; border-color: #0f3460; }

  .controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  select, button {
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    border: 1px solid #333;
    font-size: 0.95rem;
    cursor: pointer;
  }

  select {
    background: #16213e;
    color: #e0e0e0;
    flex: 1;
    min-width: 150px;
  }

  button {
    background: #0f3460;
    color: #fff;
    border: none;
    font-weight: 600;
    transition: background 0.2s;
  }
  button:hover:not(:disabled) { background: #1a5276; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-generate { flex: 0 0 auto; }

  .status {
    font-size: 0.9rem;
    color: #888;
    min-height: 1.4em;
  }
  .status.generating, .status.transcribing { color: #f0a500; }
  .status.done { color: #4ecca3; }
  .status.error { color: #e74c3c; }

  .player-section {
    display: none;
    flex-direction: column;
    gap: 0.75rem;
  }
  .player-section.visible { display: flex; }

  audio {
    width: 100%;
    border-radius: 6px;
  }

  .btn-download {
    align-self: flex-start;
    background: #4ecca3;
    color: #1a1a2e;
  }
  .btn-download:hover { background: #3db890; }

  .history {
    margin-top: 1.5rem;
    border-top: 1px solid #333;
    padding-top: 1rem;
  }
  .history h2 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: #aaa;
  }
  .history-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #16213e;
    border-radius: 6px;
    font-size: 0.85rem;
  }
  .history-item .info {
    flex: 1;
    min-width: 0;
  }
  .history-item .text-preview {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #ccc;
  }
  .history-item .meta {
    color: #666;
    font-size: 0.75rem;
  }
  .history-item button {
    padding: 0.3rem 0.8rem;
    font-size: 0.8rem;
    flex-shrink: 0;
  }

  /* Transcribe panel */
  .drop-zone {
    border: 2px dashed #333;
    border-radius: 8px;
    padding: 3rem 1rem;
    text-align: center;
    color: #888;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .drop-zone.dragover { border-color: #0f3460; background: rgba(15,52,96,0.2); }
  .drop-zone .file-name { color: #4ecca3; margin-top: 0.5rem; font-size: 0.9rem; }

  .transcript-output {
    width: 100%;
    min-height: 200px;
    padding: 1rem;
    border: 1px solid #333;
    border-radius: 8px;
    background: #16213e;
    color: #e0e0e0;
    font-size: 1rem;
    line-height: 1.5;
    font-family: inherit;
    resize: vertical;
  }

  .transcript-actions {
    display: flex;
    gap: 0.75rem;
  }
  .btn-copy { background: #4ecca3; color: #1a1a2e; }
  .btn-copy:hover { background: #3db890; }
  .btn-speak { background: #0f3460; }
</style>
</head>
<body>

<h1>Utter</h1>

<div class="tabs">
  <div class="tab active" data-tab="speak">Text to Speech</div>
  <div class="tab" data-tab="transcribe">Speech to Text</div>
</div>

<div class="container">

  <!-- TTS Panel -->
  <div class="panel active" id="panel-speak">
    <textarea id="textInput" placeholder="Enter text to speak..."></textarea>

    <div class="controls">
      <select id="voiceSelect">
        <option value="af_heart">af_heart</option>
        <option value="am_michael">am_michael</option>
        <option value="bf_emma">bf_emma</option>
      </select>
      <button class="btn-generate" id="generateBtn" onclick="generate()">Generate</button>
    </div>

    <div class="status" id="status">Idle</div>

    <div class="player-section" id="playerSection">
      <audio controls id="audioPlayer"></audio>
      <button class="btn-download" id="downloadBtn" onclick="downloadAudio()">Download</button>
    </div>

    <div class="history" id="historySection" style="display:none">
      <h2>History</h2>
      <ul class="history-list" id="historyList"></ul>
    </div>
  </div>

  <!-- STT Panel -->
  <div class="panel" id="panel-transcribe">
    <div class="drop-zone" id="dropZone">
      <div>Drop an audio file here or click to browse</div>
      <div class="file-name" id="fileName"></div>
      <input type="file" id="fileInput" accept="audio/*" style="display:none">
    </div>

    <button id="transcribeBtn" onclick="transcribeAudio()" disabled>Transcribe</button>

    <div class="status" id="sttStatus">Idle</div>

    <textarea class="transcript-output" id="transcriptOutput" placeholder="Transcript will appear here..." readonly></textarea>

    <div class="transcript-actions">
      <button class="btn-copy" id="copyBtn" onclick="copyTranscript()">Copy</button>
      <button class="btn-speak" id="speakBtn" onclick="sendToTTS()">Send to TTS</button>
    </div>
  </div>

</div>

<script>
  // --- Tab switching ---
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    });
  });

  // ===================== TTS =====================
  let polling = null;
  let currentFile = null;

  function generate() {
    const text = document.getElementById('textInput').value.trim();
    const voice = document.getElementById('voiceSelect').value;
    if (!text) return;

    document.getElementById('generateBtn').disabled = true;
    setStatus('status', 'generating', 'Generating\u2026');

    fetch('/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text, voice})
    })
    .then(r => r.json())
    .then(data => {
      if (data.status !== 'ok') {
        setStatus('status', 'error', data.message || 'Error');
        document.getElementById('generateBtn').disabled = false;
        return;
      }
      startPolling();
    })
    .catch(() => {
      setStatus('status', 'error', 'Request failed');
      document.getElementById('generateBtn').disabled = false;
    });
  }

  function startPolling() {
    if (polling) clearInterval(polling);
    polling = setInterval(() => {
      fetch('/status').then(r => r.json()).then(data => {
        if (data.state === 'done') {
          clearInterval(polling);
          polling = null;
          currentFile = data.filename;
          setStatus('status', 'done', 'Done');
          showPlayer(data.filename);
          document.getElementById('generateBtn').disabled = false;
          loadHistory();
        } else if (data.state === 'error') {
          clearInterval(polling);
          polling = null;
          setStatus('status', 'error', data.error || 'Generation failed');
          document.getElementById('generateBtn').disabled = false;
        }
      });
    }, 1000);
  }

  function setStatus(id, cls, text) {
    const el = document.getElementById(id);
    el.className = 'status ' + cls;
    el.textContent = text;
  }

  function showPlayer(filename) {
    const section = document.getElementById('playerSection');
    const player = document.getElementById('audioPlayer');
    player.src = '/audio/' + encodeURIComponent(filename);
    section.classList.add('visible');
    player.load();
    player.play().catch(() => {});
  }

  function downloadAudio() {
    if (!currentFile) return;
    const a = document.createElement('a');
    a.href = '/audio/' + encodeURIComponent(currentFile);
    a.download = currentFile;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function downloadFile(filename) {
    const a = document.createElement('a');
    a.href = '/audio/' + encodeURIComponent(filename);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function buildHistoryItem(item) {
    const li = document.createElement('li');
    li.className = 'history-item';

    const info = document.createElement('div');
    info.className = 'info';

    const preview = document.createElement('div');
    preview.className = 'text-preview';
    preview.textContent = item.text;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = item.voice + ' \u00b7 ' + item.timestamp;

    info.appendChild(preview);
    info.appendChild(meta);

    const playBtn = document.createElement('button');
    playBtn.textContent = 'Play';
    playBtn.addEventListener('click', () => {
      currentFile = item.filename;
      showPlayer(item.filename);
    });

    const dlBtn = document.createElement('button');
    dlBtn.className = 'btn-download';
    dlBtn.textContent = 'DL';
    dlBtn.addEventListener('click', () => downloadFile(item.filename));

    li.appendChild(info);
    li.appendChild(playBtn);
    li.appendChild(dlBtn);
    return li;
  }

  function loadHistory() {
    fetch('/history').then(r => r.json()).then(items => {
      const section = document.getElementById('historySection');
      const list = document.getElementById('historyList');
      if (!items.length) { section.style.display = 'none'; return; }
      section.style.display = '';
      list.replaceChildren();
      items.forEach(item => list.appendChild(buildHistoryItem(item)));
    });
  }

  loadHistory();

  // ===================== STT =====================
  let sttPolling = null;
  let selectedFile = null;

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('click', () => fileInput.click());

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) pickFile(e.dataTransfer.files[0]);
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length) pickFile(fileInput.files[0]);
  });

  function pickFile(file) {
    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('transcribeBtn').disabled = false;
  }

  function transcribeAudio() {
    if (!selectedFile) return;

    document.getElementById('transcribeBtn').disabled = true;
    document.getElementById('transcriptOutput').value = '';
    setStatus('sttStatus', 'transcribing', 'Transcribing\u2026');

    const form = new FormData();
    form.append('file', selectedFile);

    fetch('/transcribe', { method: 'POST', body: form })
    .then(r => r.json())
    .then(data => {
      if (data.status !== 'ok') {
        setStatus('sttStatus', 'error', data.message || 'Error');
        document.getElementById('transcribeBtn').disabled = false;
        return;
      }
      startSttPolling();
    })
    .catch(() => {
      setStatus('sttStatus', 'error', 'Upload failed');
      document.getElementById('transcribeBtn').disabled = false;
    });
  }

  function startSttPolling() {
    if (sttPolling) clearInterval(sttPolling);
    sttPolling = setInterval(() => {
      fetch('/transcribe/status').then(r => r.json()).then(data => {
        if (data.state === 'done') {
          clearInterval(sttPolling);
          sttPolling = null;
          document.getElementById('transcriptOutput').value = data.text;
          setStatus('sttStatus', 'done', 'Done');
          document.getElementById('transcribeBtn').disabled = false;
        } else if (data.state === 'error') {
          clearInterval(sttPolling);
          sttPolling = null;
          setStatus('sttStatus', 'error', data.error || 'Transcription failed');
          document.getElementById('transcribeBtn').disabled = false;
        }
      });
    }, 1000);
  }

  function copyTranscript() {
    const text = document.getElementById('transcriptOutput').value;
    if (!text) return;
    navigator.clipboard.writeText(text);
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  }

  function sendToTTS() {
    const text = document.getElementById('transcriptOutput').value.trim();
    if (!text) return;
    document.getElementById('textInput').value = text;
    // Switch to TTS tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelector('[data-tab="speak"]').classList.add('active');
    document.getElementById('panel-speak').classList.add('active');
  }
</script>

</body>
</html>
