<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utter</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
  }

  h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #fff;
    letter-spacing: 0.05em;
  }

  .container {
    width: 100%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  textarea {
    width: 100%;
    min-height: 250px;
    padding: 1rem;
    border: 1px solid #333;
    border-radius: 8px;
    background: #16213e;
    color: #e0e0e0;
    font-size: 1rem;
    line-height: 1.5;
    resize: vertical;
    font-family: inherit;
  }
  textarea:focus { outline: none; border-color: #0f3460; }

  .controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  select, button {
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    border: 1px solid #333;
    font-size: 0.95rem;
    cursor: pointer;
  }

  select {
    background: #16213e;
    color: #e0e0e0;
    flex: 1;
    min-width: 150px;
  }

  button {
    background: #0f3460;
    color: #fff;
    border: none;
    font-weight: 600;
    transition: background 0.2s;
  }
  button:hover:not(:disabled) { background: #1a5276; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-generate { flex: 0 0 auto; }

  .status {
    font-size: 0.9rem;
    color: #888;
    min-height: 1.4em;
  }
  .status.generating { color: #f0a500; }
  .status.done { color: #4ecca3; }
  .status.error { color: #e74c3c; }

  .player-section {
    display: none;
    flex-direction: column;
    gap: 0.75rem;
  }
  .player-section.visible { display: flex; }

  audio {
    width: 100%;
    border-radius: 6px;
  }

  .btn-download {
    align-self: flex-start;
    background: #4ecca3;
    color: #1a1a2e;
  }
  .btn-download:hover { background: #3db890; }

  .history {
    margin-top: 1.5rem;
    border-top: 1px solid #333;
    padding-top: 1rem;
  }
  .history h2 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: #aaa;
  }
  .history-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #16213e;
    border-radius: 6px;
    font-size: 0.85rem;
  }
  .history-item .info {
    flex: 1;
    min-width: 0;
  }
  .history-item .text-preview {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #ccc;
  }
  .history-item .meta {
    color: #666;
    font-size: 0.75rem;
  }
  .history-item button {
    padding: 0.3rem 0.8rem;
    font-size: 0.8rem;
    flex-shrink: 0;
  }
</style>
</head>
<body>

<h1>Utter</h1>

<div class="container">
  <textarea id="textInput" placeholder="Enter text to speak..."></textarea>

  <div class="controls">
    <select id="voiceSelect">
      <option value="af_heart">af_heart</option>
      <option value="am_michael">am_michael</option>
      <option value="bf_emma">bf_emma</option>
    </select>
    <button class="btn-generate" id="generateBtn" onclick="generate()">Generate</button>
  </div>

  <div class="status" id="status">Idle</div>

  <div class="player-section" id="playerSection">
    <audio controls id="audioPlayer"></audio>
    <button class="btn-download" id="downloadBtn" onclick="downloadAudio()">Download</button>
  </div>

  <div class="history" id="historySection" style="display:none">
    <h2>History</h2>
    <ul class="history-list" id="historyList"></ul>
  </div>
</div>

<script>
  let polling = null;
  let currentFile = null;

  function generate() {
    const text = document.getElementById('textInput').value.trim();
    const voice = document.getElementById('voiceSelect').value;
    if (!text) return;

    document.getElementById('generateBtn').disabled = true;
    setStatus('generating', 'Generating\u2026');

    fetch('/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text, voice})
    })
    .then(r => r.json())
    .then(data => {
      if (data.status !== 'ok') {
        setStatus('error', data.message || 'Error');
        document.getElementById('generateBtn').disabled = false;
        return;
      }
      startPolling();
    })
    .catch(() => {
      setStatus('error', 'Request failed');
      document.getElementById('generateBtn').disabled = false;
    });
  }

  function startPolling() {
    if (polling) clearInterval(polling);
    polling = setInterval(() => {
      fetch('/status').then(r => r.json()).then(data => {
        if (data.state === 'done') {
          clearInterval(polling);
          polling = null;
          currentFile = data.filename;
          setStatus('done', 'Done');
          showPlayer(data.filename);
          document.getElementById('generateBtn').disabled = false;
          loadHistory();
        } else if (data.state === 'error') {
          clearInterval(polling);
          polling = null;
          setStatus('error', data.error || 'Generation failed');
          document.getElementById('generateBtn').disabled = false;
        }
      });
    }, 1000);
  }

  function setStatus(cls, text) {
    const el = document.getElementById('status');
    el.className = 'status ' + cls;
    el.textContent = text;
  }

  function showPlayer(filename) {
    const section = document.getElementById('playerSection');
    const player = document.getElementById('audioPlayer');
    player.src = '/audio/' + encodeURIComponent(filename);
    section.classList.add('visible');
    player.load();
    player.play().catch(() => {});
  }

  function downloadAudio() {
    if (!currentFile) return;
    const a = document.createElement('a');
    a.href = '/audio/' + encodeURIComponent(currentFile);
    a.download = currentFile;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function downloadFile(filename) {
    const a = document.createElement('a');
    a.href = '/audio/' + encodeURIComponent(filename);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function buildHistoryItem(item) {
    const li = document.createElement('li');
    li.className = 'history-item';

    const info = document.createElement('div');
    info.className = 'info';

    const preview = document.createElement('div');
    preview.className = 'text-preview';
    preview.textContent = item.text;

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = item.voice + ' \u00b7 ' + item.timestamp;

    info.appendChild(preview);
    info.appendChild(meta);

    const playBtn = document.createElement('button');
    playBtn.textContent = 'Play';
    playBtn.addEventListener('click', () => {
      currentFile = item.filename;
      showPlayer(item.filename);
    });

    const dlBtn = document.createElement('button');
    dlBtn.className = 'btn-download';
    dlBtn.textContent = 'DL';
    dlBtn.addEventListener('click', () => downloadFile(item.filename));

    li.appendChild(info);
    li.appendChild(playBtn);
    li.appendChild(dlBtn);
    return li;
  }

  function loadHistory() {
    fetch('/history').then(r => r.json()).then(items => {
      const section = document.getElementById('historySection');
      const list = document.getElementById('historyList');
      if (!items.length) { section.style.display = 'none'; return; }
      section.style.display = '';
      list.replaceChildren();
      items.forEach(item => list.appendChild(buildHistoryItem(item)));
    });
  }

  // Load history on page load
  loadHistory();
</script>

</body>
</html>
